openapi: 3.0.3
info:
  title: XRPL MPT Traceability Service API
  description: |
    REST API for a backend service that handles Multi-Purpose Tokens (MPT) on XRPL (XRP Ledger).

    Manages MPT mint / transfer / burn (clawback) operations, providing secure key management,
    idempotency guarantees, and resumable state management.

    **Note**: Authentication is not currently implemented (PoC stage)
  version: 1.0.0
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: http://localhost:3005
    description: Local development environment
  - url: https://api.example.com
    description: Production environment (not implemented)

tags:
  - name: health
    description: Health check
  - name: wallets
    description: Wallet management
  - name: operations
    description: MPT operations (mint/transfer/burn)

paths:
  /health:
    get:
      tags:
        - health
      summary: Health check
      description: Checks the server status
      operationId: getHealth
      responses:
        '200':
          description: Server is operating normally
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                    example: '2026-01-05T07:00:00.000Z'

  /api/wallets:
    post:
      tags:
        - wallets
      summary: Create user wallet
      description: |
        Creates a new XRPL user wallet.

        **Note**: Issuer wallet is managed via .env.
      operationId: createWallet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWalletRequest'
      responses:
        '201':
          description: Wallet created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WalletResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/wallets/{walletId}:
    get:
      tags:
        - wallets
      summary: Get wallet
      description: Retrieves information for the specified wallet
      operationId: getWallet
      parameters:
        - $ref: '#/components/parameters/WalletIdPath'
      responses:
        '200':
          description: Wallet information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WalletResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/wallets/{walletId}/fund:
    post:
      tags:
        - wallets
      summary: Fund wallet
      description: |
        Supplies XRP to a user wallet from the testnet/devnet faucet.

        **Note**:
        - Testnet/devnet only (not available in production)
        - Cannot fund issuer wallet
        - Fixed amount of 1000 XRP is supplied
        - Faucet has rate limits (5-10 requests/minute)
      operationId: fundWallet
      parameters:
        - $ref: '#/components/parameters/WalletIdPath'
      responses:
        '200':
          description: Funding completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FundWalletResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/operations/mint:
    post:
      tags:
        - operations
      summary: Mint operation
      description: |
        Issues MPT and distributes it to a user.

        Process flow:
        1. Issuer mints MPT (MPTokenIssuanceCreate)
        2. User authorizes (MPTokenAuthorize)
        3. Issuer transfers to User (Payment)

        Notes:
        - Issuer is automatically determined from ISSUER_SEED environment variable
        - assetScale is always fixed to 0
        - maximumAmount is automatically set equal to the specified amount
        - transferFee is always fixed to 0
      operationId: createMintOperation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MintRequest'
      responses:
        '201':
          description: Mint operation created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
        '200':
          description: Operation already exists with the same idempotency key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/operations/transfer:
    post:
      tags:
        - operations
      summary: Transfer operation
      description: |
        Transfers MPT from one user to another.

        Process flow:
        1. Receiver authorizes (MPTokenAuthorize)
        2. Sender transfers (Payment)
      operationId: createTransferOperation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferRequest'
      responses:
        '201':
          description: Transfer operation created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
        '200':
          description: Operation already exists with the same idempotency key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/operations/burn:
    post:
      tags:
        - operations
      summary: Burn operation
      description: |
        Issuer clawbacks (retrieves) MPT from a holder.

        Process flow:
        1. Issuer clawbacks (Clawback)
      operationId: createBurnOperation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BurnRequest'
      responses:
        '201':
          description: Burn operation created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
        '200':
          description: Operation already exists with the same idempotency key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/operations/{operationId}:
    get:
      tags:
        - operations
      summary: Get operation status (detailed)
      description: Retrieves detailed status and all steps of an operation
      operationId: getOperationStatus
      parameters:
        - $ref: '#/components/parameters/OperationIdPath'
        - name: status
          in: query
          description: If true, returns only lightweight status
          required: false
          schema:
            type: boolean
      responses:
        '200':
          description: Operation status
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/OperationDetailResponse'
                  - $ref: '#/components/schemas/OperationLightweightResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    CreateWalletRequest:
      type: object
      properties:
        seed:
          type: string
          description: (Optional) Used when importing an existing seed
          example: sXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

    WalletResponse:
      type: object
      properties:
        id:
          type: string
          description: Wallet ID (UUID or 'issuer')
          example: 123e4567-e89b-12d3-a456-426614174000
        xrplAddress:
          type: string
          description: XRPL address
          example: rN7n7otQDd6FczFgLdHmTKPSSmfLvUMnQR
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Update timestamp

    FundWalletResponse:
      type: object
      properties:
        walletId:
          type: string
          format: uuid
          description: Wallet ID
          example: 123e4567-e89b-12d3-a456-426614174000
        xrplAddress:
          type: string
          description: XRPL address
          example: rN7n7otQDd6FczFgLdHmTKPSSmfLvUMnQR
        balanceBefore:
          type: number
          description: Balance before funding (XRP)
          example: 0
        balanceAfter:
          type: number
          description: Balance after funding (XRP)
          example: 1000
        amountFunded:
          type: string
          description: Amount funded (XRP)
          example: '1000'

    MintRequest:
      type: object
      required:
        - idempotencyKey
        - userWalletId
        - amount
      properties:
        idempotencyKey:
          type: string
          description: Idempotency key (prevents duplicate execution)
          example: mint-001
        userWalletId:
          type: string
          format: uuid
          description: Recipient's wallet ID
          example: 223e4567-e89b-12d3-a456-426614174000
        amount:
          type: string
          description: |
            Issuance amount (string)

            Note: This value is also automatically used as maximumAmount.
            This means the specified amount becomes the maximum issuable amount.
          example: '1000'
        metadata:
          type: string
          description: MPT metadata (optional)
          example: My First MPT

    TransferRequest:
      type: object
      required:
        - idempotencyKey
        - fromWalletId
        - toWalletId
        - issuanceId
        - amount
      properties:
        idempotencyKey:
          type: string
          description: Idempotency key
          example: transfer-001
        fromWalletId:
          type: string
          format: uuid
          description: Sender's wallet ID
        toWalletId:
          type: string
          format: uuid
          description: Receiver's wallet ID
        issuanceId:
          type: string
          description: MPT Issuance ID
          example: 000000012345678900000000ABCDEF1234567890
        amount:
          type: string
          description: Transfer amount
          example: '500'

    BurnRequest:
      type: object
      required:
        - idempotencyKey
        - issuerWalletId
        - holderWalletId
        - issuanceId
        - amount
      properties:
        idempotencyKey:
          type: string
          description: Idempotency key
          example: burn-001
        issuerWalletId:
          type: string
          format: uuid
          description: Issuer's wallet ID
        holderWalletId:
          type: string
          format: uuid
          description: Holder's wallet ID
        issuanceId:
          type: string
          description: MPT Issuance ID
          example: 000000012345678900000000ABCDEF1234567890
        amount:
          type: string
          description: Clawback amount
          example: '100'

    OperationResponse:
      type: object
      properties:
        operationId:
          type: string
          format: uuid
          description: Operation ID
        status:
          $ref: '#/components/schemas/OperationStatus'
        message:
          type: string
          description: Message
          example: Mint operation created and execution started
        issuanceId:
          type: string
          description: MPT Issuance ID (if exists)
        steps:
          type: array
          description: Steps summary
          items:
            type: object
            properties:
              stepNo:
                type: integer
                description: Step number
              kind:
                type: string
                description: Step type
              status:
                $ref: '#/components/schemas/StepStatus'

    OperationDetailResponse:
      type: object
      properties:
        operation:
          type: object
          properties:
            id:
              type: string
              format: uuid
            type:
              $ref: '#/components/schemas/OperationType'
            idempotencyKey:
              type: string
            issuanceId:
              type: string
              nullable: true
            fromWalletId:
              type: string
              format: uuid
              nullable: true
            toWalletId:
              type: string
              format: uuid
              nullable: true
            amount:
              type: string
            status:
              $ref: '#/components/schemas/OperationStatus'
            errorCode:
              type: string
              nullable: true
            errorMessage:
              type: string
              nullable: true
            createdAt:
              type: string
              format: date-time
            updatedAt:
              type: string
              format: date-time
        steps:
          type: array
          items:
            $ref: '#/components/schemas/OperationStep'

    OperationLightweightResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          $ref: '#/components/schemas/OperationType'
        status:
          $ref: '#/components/schemas/OperationStatus'
        issuanceId:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OperationStep:
      type: object
      properties:
        id:
          type: string
          format: uuid
        stepNo:
          type: integer
        kind:
          type: string
        walletId:
          type: string
          format: uuid
        txType:
          type: string
        txHash:
          type: string
          nullable: true
        status:
          $ref: '#/components/schemas/StepStatus'
        submitResult:
          type: object
          nullable: true
        validatedResult:
          type: object
          nullable: true
        lastCheckedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OperationType:
      type: string
      enum: [mint, transfer, burn]
      description: Operation type

    OperationStatus:
      type: string
      enum: [PENDING, IN_PROGRESS, SUCCESS, FAILED]
      description: |
        Operation status:
        - PENDING: Waiting for execution
        - IN_PROGRESS: Executing
        - SUCCESS: Completed
        - FAILED: Failed

    StepStatus:
      type: string
      enum: [PENDING, SUBMITTED, PENDING_VALIDATION, VALIDATED_SUCCESS, VALIDATED_FAILED, TIMEOUT]
      description: |
        Step status:
        - PENDING: Not executed
        - SUBMITTED: Transaction submitted
        - PENDING_VALIDATION: Awaiting validation
        - VALIDATED_SUCCESS: Validation succeeded
        - VALIDATED_FAILED: Validation failed
        - TIMEOUT: Timeout

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
        details:
          type: string
          description: Detailed error information
        required:
          type: array
          description: Required fields (for validation errors)
          items:
            type: string

  parameters:
    WalletIdPath:
      name: walletId
      in: path
      required: true
      description: Wallet ID
      schema:
        type: string
        format: uuid

    OperationIdPath:
      name: operationId
      in: path
      required: true
      description: Operation ID
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Missing required fields
            required: [idempotencyKey, issuerWalletId, userWalletId, amount]

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Operation not found

    InternalServerError:
      description: Server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: Internal server error
            details: Unexpected error occurred
